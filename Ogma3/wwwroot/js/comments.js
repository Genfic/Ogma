async function o(e,t,n,a,i){let s=await fetch(e,{method:t,headers:{"Content-Type":"application/json",...a},body:n?JSON.stringify(n):null,...i}),c=s.headers.get("content-type"),r;if(c?.includes("application/json"))r=await s.json();else r=await s.text();return{ok:s.ok,status:s.status,statusText:s.statusText,headers:s.headers,data:r}}var d=async(e,t,n,a,i)=>await o(`/api/comments?thread=${e}&page=${t}&highlight=${n}`,"GET",void 0,a,i);var u=async(e,t,n)=>await o(`/api/CommentsThread/${e}`,"GET",void 0,t,n);var p=async(e,t,n)=>await o("/api/comments","POST",e,t,n),m=async(e,t,n)=>await o("/api/CommentsThread/lock","POST",e,t,n);new Vue({el:"#comments-container",data:{body:"",thread:null,csrf:null,type:null,minLength:0,maxLength:0,comments:[],total:0,page:1,perPage:10,opName:null,authenticatedAs:!1,canLock:!1,isSubscribed:!1,isLocked:!1,highlight:null,collapse:JSON.parse(window.localStorage.getItem("collapse-deleted")),isReady:!1},methods:{submit:async function(e){if(e.preventDefault(),this.body.length>=this.maxLength)return;if(!(await p({body:this.body,thread:Number(this.thread),source:this.type},{RequestVerificationToken:this.csrf})).ok)return;this.highlight=this.total+1,this.page=1,await this.load(),this.body=""},load:async function(){let e=await d(this.thread,this.page,this.highlight??-1),t=e.data;if(this.total=t.total,this.page=t.page??this.page,this.authenticatedAs=e.headers.get("x-username").toLowerCase(),this.comments=Object.entries(t.elements).map(([n,a])=>({val:a,key:t.total-this.page*this.perPage+(this.perPage-(Number.parseInt(n)+1))})),this.highlight)this.$nextTick(()=>this.changeHighlight());else this.navigateToPage();if(this.isReady)return;this.$nextTick(function(){this.isReady=!0})},enter:async function(e){if(e.ctrlKey)await this.submit(e)},prevPage:async function(){await this.changePage(Math.max(1,this.page-1))},nextPage:async function(){await this.changePage(Math.min(this.page+1,Math.ceil(this.total/this.perPage)))},changePage:async function(e){this.page=e,this.navigateToPage(),await this.load()},changeHighlight:function(e=null,t=null){if(t)t.preventDefault();this.highlight=e??this.highlight,document.getElementById(`comment-${this.highlight}`).scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),history.replaceState(void 0,void 0,`#comment-${this.highlight}`)},navigateToPage:function(){let e=this.page>1?`#page-${this.page}`:window.location.href.split("#")[0];if(history.replaceState(null,null,e),this.highlight)this.highlight=null},report:function(e){this.$refs.reportModal.mutId=e,this.$refs.reportModal.visible=!0},lock:async function(){if(!this.canLock)return!1;let e=await m({threadId:this.thread});return this.isLocked=e.ok&&e.data,this.isLocked}},computed:{comms:function(){if(this.collapse!==!0)return this.comments;let e=[],t=0;for(let n of this.comments)if(!n.val.deletedBy){if(t!==0)e.push({snip:`Removed ${t} comments.`});t=0,e.push(n)}else t+=1;return e}},async mounted(){let e=this.$refs.container;this.csrf=e.dataset.csrf,this.thread=e.dataset.id;let t=async()=>{let i=await u(this.thread);if(i.ok){this.canLock=i.headers.get("X-IsStaff").toLowerCase()==="true";let s=i.data;this.isLocked=s.isLocked,this.perPage=s.perPage,this.minLength=s.minCommentLength,this.maxLength=s.maxCommentLength,this.type=s.source}},n=async()=>{await this.load()};await Promise.allSettled([t(),n()]);let a=window.location.hash.split("-");if(a[0]==="#page"&&a[1])this.page=Math.max(1,Number(a[1]??1));else if(a[0]==="#comment"&&a[1])this.page=1,this.highlight=Number(a[1]);else this.page=1,history.replaceState(void 0,void 0,"")}});

//# debugId=BB48907C6EB922A064756E2164756E21
//# sourceMappingURL=comments.js.map
